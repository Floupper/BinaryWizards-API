image: node:latest

prepare_env:
  script:
    - echo "DATABASE_URL=$DATABASE_URL" > .env
    - echo "JWT_SECRET=$JWT_SECRET" >> .env
    - echo "JWT_EXPIRES_IN=$JWT_EXPIRES_IN" >> .env
  artifacts:
    paths:
      - .env

test:
  needs:
    - prepare_env
  script:
    - npm install
    - npm test --coverage --coverageDirectory=coverage --coverageProvider=babel --outputFile=test-results.xml
  artifacts:
    when: always
    reports:
      junit: coverage/test-results.xml
    paths:
      - coverage/test-results.xml
  allow_failure: true

build:
  needs:
    - test
  script:
    - echo "Build process started..."
    - echo "Build process completed."
  artifacts:
    when: on_success

deploy:
  needs:
    - build
  script:
    - echo "Deploy process started..."
    - echo "Deploy process completed."


trigger_web:
  needs:
    - test
  trigger:
    project: "binarywizards/s5-binarywizards-web"
    branch: "main"  
    strategy: depend

trigger_mobile:
  needs:
    - test
  trigger:
    project: "binarywizards/s5-binarywizards-mobile"
    branch: "main"
    strategy: depend
